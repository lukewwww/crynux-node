name: Create and publish the Standalone LXC image

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'build manually trigger'
        required: true
        default: 'triggered by developer'
      blockchain:
        description: 'Blockchain'
        required: true
        default: 'dymension'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      BLOCKCHAIN: ${{ inputs.blockchain || 'dymension' }}

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 35840
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Set the config files
        run: bash build/set-config-files.sh "$BLOCKCHAIN"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap gpg squashfs-tools

      - name: Install distrobuilder via Snap
        run: |
          # Per official documentation, snap is the recommended way to install distrobuilder.
          # We rely on the snap to be self-contained with its core dependencies.
          sudo snap install distrobuilder --classic

      - name: Build LXC image with distrobuilder
        run: |
          # The snap installation places distrobuilder directly in the PATH.
          sudo -E distrobuilder build-lxc build/lxc/crynux-node.lxc.yaml -o image.architecture=$(dpkg --print-architecture)

      - name: List generated files
        run: |
          echo "Files generated by distrobuilder:"
          ls -la *.tar.xz || echo "No .tar.xz files found"
          echo "All files in current directory:"
          ls -la

      - name: Get commit hash
        id: vars
        shell: bash
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Change ownership of artifacts
        run: sudo chown runner:runner rootfs.tar.xz meta.tar.xz

      - name: Install Incus client
        run: |
          # Add Zabbly repository for Incus
          curl -fsSL https://pkgs.zabbly.com/key.asc | sudo gpg --dearmor -o /etc/apt/keyrings/zabbly.gpg
          echo "deb [signed-by=/etc/apt/keyrings/zabbly.gpg] https://pkgs.zabbly.com/incus/stable $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/zabbly-incus.list
          sudo apt update
          sudo apt install -y incus-client

      - name: Setup Incus client certificates
        env:
          INCUS_CLIENT_CERT: ${{ secrets.INCUS_CLIENT_CERT }}
          INCUS_CLIENT_KEY: ${{ secrets.INCUS_CLIENT_KEY }}
        run: |
          mkdir -p ~/.config/incus
          echo "$INCUS_CLIENT_CERT" > ~/.config/incus/client.crt
          echo "$INCUS_CLIENT_KEY" > ~/.config/incus/client.key
          chmod 600 ~/.config/incus/client.key
          chmod 644 ~/.config/incus/client.crt

      - name: Configure registry remote
        run: |
          incus remote add crynux-network-admin https://lxc.crynux.io:8555 --accept-certificate

      - name: Publish image to registry
        run: |
          # Use commit hash as version
          VERSION="${{ steps.vars.outputs.sha_short }}-${{ env.BLOCKCHAIN }}"

          # Publish image with proper alias
          incus image import meta.tar.xz rootfs.tar.xz crynux-network-admin: \
            --alias "crynux-node:${VERSION}" \
            --public

          echo "Published crynux-node:${VERSION} to registry"

      - name: Upload LXC image artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: crynux-node-lxc-image-${{ steps.vars.outputs.sha_short }}-${{ env.BLOCKCHAIN }}
          path: |
            rootfs.tar.xz
            meta.tar.xz
