# build/lxc/crynux-node.lxc.yaml
image:
  description: Crynux Node LXC Image
  distribution: ubuntu
  release: "jammy"
  architecture: amd64

source:
  downloader: debootstrap
  url: http://archive.ubuntu.com/ubuntu/
  components: ["main", "universe"]

# For distrobuilder v3+, GPG key handling is done by copying the file
# into the image explicitly, rather than using a 'keyring' property.
files:
  - path: /etc/apt/trusted.gpg.d/ubuntu-archive-keyring.gpg
    source: /usr/share/keyrings/ubuntu-archive-keyring.gpg
    perms: "0644"

packages:
  manager: apt
  update: true
  cleanup: true
  sets:
    - action: install
      packages:
        # Base dependencies from Dockerfile
        - python3.10
        - python3.10-venv
        - python3.10-dev
        - python3-pip
        - curl
        - build-essential
        - libssl-dev
        - libffi-dev
        - ffmpeg
        - libsm6
        - libxext6
        - wget
        # For Node.js/yarn to build web UI
        - ca-certificates
        - gnupg
        # For Go
        - git
    - action: remove
      packages:
        - build-essential
        - python3.10-dev
        - libssl-dev
        - libffi-dev
        - curl
        - wget
        - git
        - gnupg
        - nodejs

actions:
  - trigger: post-packages
    action: |
      set -eux
      # The source code is mounted at /crynux-node by distrobuilder.
      # We make the build script executable and then run it.
      chmod +x /crynux-node/build/lxc/build.sh
      /crynux-node/build/lxc/build.sh
